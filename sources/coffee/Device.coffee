###########################################################################
# DEVICE CONFIGURATIONS

devicesShortcuts =
	iPad : "apple-ipad-air-space-gray"
	iPadSilver : "apple-ipad-air-silver"
	iPadGold : "apple-ipad-air-gold"
	iPadSpaceGray : "apple-ipad-air-space-gray"

	iPadMini : "apple-ipad-mini-space-gray"
	iPadMiniSilver : "apple-ipad-mini-silver"
	iPadMiniGold : "apple-ipad-mini-gold"
	iPadMiniSpaceGray : "apple-ipad-mini-space-gray"

	iPadPro : "apple-ipad-pro-space-gray"
	iPadProSilver : "apple-ipad-pro-silver"
	iPadProGold : "apple-ipad-pro-gold"
	iPadProSpaceGray : "apple-ipad-pro-space-gray"

	iPhone : "apple-iphone-7-black"
	iPhoneGold : "apple-iphone-7-gold"
	iPhoneRoseGold : "apple-iphone-7-rose-gold"
	iPhoneSilver : "apple-iphone-7-silver"
	iPhoneJetBlack : "apple-iphone-7-jet-black"
	iPhoneBlack : "apple-iphone-7-black"

	iPhone6 : "apple-iphone-6s-space-gray"
	iPhone6Gold : "apple-iphone-6s-gold"
	iPhone6Gold : "apple-iphone-6s-rose-gold"	
	iPhone6Gold : "apple-iphone-6s-silver"
	iPhone6Gold : "apple-iphone-6s-space-gray"

	iPhone6Plus : "apple-iphone-6s-plus-space-gray"
	iPhone6PlusGold : "apple-iphone-6s-plus-gold"
	iPhone6PlusGold : "apple-iphone-6s-plus-rose-gold"
	iPhone6PlusGold : "apple-iphone-6s-plus-silver"
	iPhone6PlusGold : "apple-iphone-6s-plus-space-gray"

	iPhone5S : "apple-iphone-5s-space-gray"
	iPhone5Gold : "apple-iphone-5s-gold"
	iPhone5Silver : "apple-iphone-5s-silver"
	iPhone5SpaceGray : "apple-iphone-5s-space-gray"

	iPhone5C : "apple-iphone-5c-blue"
	iPhone5CBlue : "apple-iphone-5c-blue"
	iPhone5CGreen : "apple-iphone-5c-green"
	iPhone5CRed : "apple-iphone-5c-red"
	iPhone5CWhite : "apple-iphone-5c-white"
	iPhone5CYellow : "apple-iphone-5c-yellow"

	appleWatch38NikePlusSilverAluminumFlatSilverVold : "apple-watch-nike-plus-38mm-silver-aluminum-flat-silver-volt"
	appleWatch38NikePlusSilverAluminumFlatSilverWhite : "apple-watch-nike-plus-38mm-silver-aluminum-flat-silver-white"
	appleWatch38NikePlusSpaceGrayAluminumBlackCoolGray : "apple-watch-nike-plus-38mm-space-gray-aluminum-black-cool-gray"
	appleWatch38NikePlusSpaceGrayAluminumBlackVold : "apple-watch-nike-plus-38mm-space-gray-aluminum-black-volt"

	appleWatch : "apple-watch-nike-plus-42mm-silver-aluminum-flat-silver-volt"
	appleWatch42NikePlusSilverAluminumFlatSilverVold : "apple-watch-nike-plus-42mm-silver-aluminum-flat-silver-volt"
	appleWatch42NikePlusSilverAluminumFlatSilverWhite : "apple-watch-nike-plus-42mm-silver-aluminum-flat-silver-white"
	appleWatch42NikePlusSpaceGrayAluminumBlackCoolGray : "apple-watch-nike-plus-42mm-space-gray-aluminum-black-cool-gray"
	appleWatch42NikePlusSpaceGrayAluminumBlackVold : "apple-watch-nike-plus-42mm-space-gray-aluminum-black-volt"

	nexus4 : "google-nexus-4"
	nexus5 : "google-nexus-5x"
	nexus6 : "google-nexus-6p"

	pixel : "google-pixel-quite-black"
	pixelBlack : "google-pixel-quite-black"
	pixelBlue : "google-pixel-really-blue"
	pixelSilver : "google-pixel-very-silver"

	htcOneA9 : "htc-one-a9-black"
	htcOneA9Black : "htc-one-a9-black"
	htcOneA9White : "htc-one-a9-white"

	htcOneM8 : "htc-one-m8-black"
	htcOneM8Black : "htc-one-m8-black"
	htcOneM8Gold : "htc-one-m8-gold"
	htcOneM8Silver : "htc-one-m8-silver"

	lumia950 : "microsoft-lumia-950-black"
	lumia950Black : "microsoft-lumia-950-black"
	lumia950White : "microsoft-lumia-950-white"

	galaxyNote5 : "samsung-galaxy-note-5-black"
	galaxyNote5Black : "samsung-galaxy-note-5-black"
	galaxyNote5Gold : "samsung-galaxy-note-5-gold"
	galaxyNote5Pink : "samsung-galaxy-note-5-pink"
	galaxyNote5SilverTitanium : "samsung-galaxy-note-5-silver-titanium"
	galaxyNote5White : "samsung-galaxy-note-5-white"

	macbook : "apple-macbook"
	macbookAir : "apple-macbook-air"
	macbookPro : "apple-macbook-pro"

	iMac : "apple-imac"



devicesConfiguationsData =
	iPadAir 			: ["tablet", 1856, 2608, 1536, 2048, 2]
	iPadMini 			: ["tablet", 1936, 2688, 1536, 2048, 2]
	iPadPro 			: ["tablet", 2448, 3432, 2048, 2732, 2]
	iPhone7 			: ["phone", 874, 1792, 750, 1334, 2]
	iPhone7Plus 		: ["phone", 1452, 2968, 1242, 2208, 3]
	iPhone6 			: ["phone", 874, 1792, 750, 1334, 2]
	iPhone6Plus 		: ["phone", 1452, 2968, 1242, 2208, 3]
	iPhone5 			: ["phone", 768, 1612, 640, 1136, 2]
	iPhone5C 			: ["phone", 776, 1620, 640, 1136, 2]
	Nexus4 				: ["phone", 860, 1668, 768, 1280, 2]
	Nexus5 				: ["phone", 1204, 2432, 1080, 1920, 3]
	Nexus6 				: ["phone", 1576, 3220, 1440, 2560, 3]
	Pixel 				: ["phone", 1224, 2492, 1080, 1920, 3]
	HTCa9 				: ["phone", 1252, 2592, 1080, 1920, 3]
	HTCm8 				: ["phone", 1232, 2572, 1080, 1920, 3]
	MSFTLumia950 		: ["phone", 1660, 3292, 1440, 2560, 3]
	SamsungGalaxyNote5 	: ["phone", 1572, 3140, 1440, 2560, 3]
	AppleWatch42 		: ["watch", 512, 990, 312, 390, 2]
	AppleWatch38 		: ["watch", 472, 772, 272, 340, 2]
	AppleMacBook 		: ["computer", 3084, 1860, 2304, 1440, 2]
	AppleMacBookAir 	: ["computer", 2000, 1220, 1440, 900, 1]
	AppleMacBookPro 	: ["computer", 3820, 2320, 2880, 1800, 2]
	AppleIMac 			: ["computer", 2800, 2940, 2560, 1440, 1]

devicesConfiguations = {}
for item of devicesConfiguationsData
	devicesConfiguations[item] = 
		type 			: devicesConfiguationsData[item][0]
		imageWidth 		: devicesConfiguationsData[item][1]
		imageHeight 	: devicesConfiguationsData[item][2]
		screenWidth 	: devicesConfiguationsData[item][3]
		screenHeight 	: devicesConfiguationsData[item][4]
		screenDensity	 : devicesConfiguationsData[item][5]


###########################################################################
# DEVICES

Devices =

	# iPad Air
	"apple-ipad-air-silver"			: Utils.clone(devicesConfiguations.iPadAir)
	"apple-ipad-air-gold"			: Utils.clone(devicesConfiguations.iPadAir)
	"apple-ipad-air-space-gray"		: Utils.clone(devicesConfiguations.iPadAir)

	# iPad Mini
	"apple-ipad-mini-silver"		: Utils.clone(devicesConfiguations.iPadMini)
	"apple-ipad-mini-gold"			: Utils.clone(devicesConfiguations.iPadMini)
	"apple-ipad-mini-space-gray"	: Utils.clone(devicesConfiguations.iPadMini)

	# iPad Pro
	"apple-ipad-pro-silver"			: Utils.clone(devicesConfiguations.iPadPro)
	"apple-ipad-pro-gold"			: Utils.clone(devicesConfiguations.iPadPro)
	"apple-ipad-pro-space-gray"		: Utils.clone(devicesConfiguations.iPadPro)

	# iPhone 7
	"apple-iphone-7-gold"			: Utils.clone(devicesConfiguations.iPhone7)
	"apple-iphone-7-rose-gold"		: Utils.clone(devicesConfiguations.iPhone7)
	"apple-iphone-7-silver"			: Utils.clone(devicesConfiguations.iPhone7)
	"apple-iphone-7-black"			: Utils.clone(devicesConfiguations.iPhone7)
	"apple-iphone-7-jet-black"		: Utils.clone(devicesConfiguations.iPhone7)

	# iPhone 7 Plus
	"apple-iphone-7-plus-gold"		: Utils.clone(devicesConfiguations.iPhone7Plus)
	"apple-iphone-7-plus-rose-gold"	: Utils.clone(devicesConfiguations.iPhone7Plus)
	"apple-iphone-7-plus-silver"	: Utils.clone(devicesConfiguations.iPhone7Plus)
	"apple-iphone-7-plus-black"		: Utils.clone(devicesConfiguations.iPhone7Plus)
	"apple-iphone-7-plus-jet-black"	: Utils.clone(devicesConfiguations.iPhone7Plus)

	# iPhone 6s
	"apple-iphone-6s-gold"			: Utils.clone(devicesConfiguations.iPhone6)
	"apple-iphone-6s-rose-gold"		: Utils.clone(devicesConfiguations.iPhone6)
	"apple-iphone-6s-silver"		: Utils.clone(devicesConfiguations.iPhone6)
	"apple-iphone-6s-space-gray"	: Utils.clone(devicesConfiguations.iPhone6)

	# iPhone 6s Plus
	"apple-iphone-6s-plus-gold"			: Utils.clone(devicesConfiguations.iPhone6Plus)
	"apple-iphone-6s-plus-rose-gold"	: Utils.clone(devicesConfiguations.iPhone6Plus)
	"apple-iphone-6s-plus-silver"		: Utils.clone(devicesConfiguations.iPhone6Plus)
	"apple-iphone-6s-plus-space-gray"	: Utils.clone(devicesConfiguations.iPhone6Plus)

	# iPhone 5S
	"apple-iphone-5s-gold"				: Utils.clone(devicesConfiguations.iPhone5)
	"apple-iphone-5s-silver"			: Utils.clone(devicesConfiguations.iPhone5)
	"apple-iphone-5s-space-gray"		: Utils.clone(devicesConfiguations.iPhone5)

	# iPhone 5C
	"apple-iphone-5c-blue"				: Utils.clone(devicesConfiguations.iPhone5C)
	"apple-iphone-5c-green"				: Utils.clone(devicesConfiguations.iPhone5C)
	"apple-iphone-5c-red"				: Utils.clone(devicesConfiguations.iPhone5C)
	"apple-iphone-5c-white"				: Utils.clone(devicesConfiguations.iPhone5C)
	"apple-iphone-5c-yellow"			: Utils.clone(devicesConfiguations.iPhone5C)

	# Apple Watch Nike+ 38mm
	"apple-watch-nike-plus-38mm-silver-aluminum-flat-silver-volt"		: Utils.clone(devicesConfiguations.AppleWatch38)
	"apple-watch-nike-plus-38mm-silver-aluminum-flat-silver-white"		: Utils.clone(devicesConfiguations.AppleWatch38)
	"apple-watch-nike-plus-38mm-space-gray-aluminum-black-cool-gray"	: Utils.clone(devicesConfiguations.AppleWatch38)
	"apple-watch-nike-plus-38mm-space-gray-aluminum-black-volt"			: Utils.clone(devicesConfiguations.AppleWatch38)

	# Apple Watch Nike+ 42mm
	"apple-watch-nike-plus-42mm-silver-aluminum-flat-silver-volt"		: Utils.clone(devicesConfiguations.AppleWatch42)
	"apple-watch-nike-plus-42mm-silver-aluminum-flat-silver-white"		: Utils.clone(devicesConfiguations.AppleWatch42)
	"apple-watch-nike-plus-42mm-space-gray-aluminum-black-cool-gray"	: Utils.clone(devicesConfiguations.AppleWatch42)
	"apple-watch-nike-plus-42mm-space-gray-aluminum-black-volt"			: Utils.clone(devicesConfiguations.AppleWatch42)

	# NEXUS
	"google-nexus-4"				: Utils.clone(devicesConfiguations.Nexus4)
	"google-nexus-5x"				: Utils.clone(devicesConfiguations.Nexus5)
	"google-nexus-6p"				: Utils.clone(devicesConfiguations.Nexus6)

	# Pixel
	"google-pixel-quite-black"		: Utils.clone(devicesConfiguations.Pixel)
	"google-pixel-really-blue"		: Utils.clone(devicesConfiguations.Pixel)
	"google-pixel-very-silver"		: Utils.clone(devicesConfiguations.Pixel)

	# HTC ONE A9
	"htc-one-a9-black"				: Utils.clone(devicesConfiguations.HTCa9)
	"htc-one-a9-white"				: Utils.clone(devicesConfiguations.HTCa9)

	# HTC ONE M8
	"htc-one-m8-black"				: Utils.clone(devicesConfiguations.HTCm8)
	"htc-one-m8-gold"				: Utils.clone(devicesConfiguations.HTCm8)
	"htc-one-m8-silver"				: Utils.clone(devicesConfiguations.HTCm8)

	# MICROSOFT LUMIA 950
	"microsoft-lumia-950-black"		: Utils.clone(devicesConfiguations.MSFTLumia950)
	"microsoft-lumia-950-white"		: Utils.clone(devicesConfiguations.MSFTLumia950)

	# SAMSUNG NOTE 5
	"samsung-galaxy-note-5-black"				: Utils.clone(devicesConfiguations.SamsungGalaxyNote5)
	"samsung-galaxy-note-5-gold"				: Utils.clone(devicesConfiguations.SamsungGalaxyNote5)
	"samsung-galaxy-note-5-pink"				: Utils.clone(devicesConfiguations.SamsungGalaxyNote5)
	"samsung-galaxy-note-5-silver-titanium"		: Utils.clone(devicesConfiguations.SamsungGalaxyNote5)
	"samsung-galaxy-note-5-white"				: Utils.clone(devicesConfiguations.SamsungGalaxyNote5)

	# Notebooks
	"apple-macbook"								: Utils.clone(devicesConfiguations.AppleMacBook)
	"apple-macbook-air"							: Utils.clone(devicesConfiguations.AppleMacBookAir)
	"apple-macbook-pro"							: Utils.clone(devicesConfiguations.AppleMacBookPro)

	# Desktops
	"apple-imac"								: Utils.clone(devicesConfiguations.AppleIMac)

BuiltInDevices = Utils.keys(Devices)

class Device extends View

	constructor: (options={}) ->
		super

		return if Utils.isMobile()

		@_setup()
		#@type = 'apple-iphone-7-jet-black' if not options.type
		@height = '100%'
		that = @
		App.onResize ->
			if not Utils.isMobile() 
				that._update()
			else
				that._orientationChange()

	_kind : 'Device'
	_device : {}
	_type : NULL
	_setupDone : no
	_contentScale : 1
	_orientation : 0

	phone : {}
	isLandscape : no

	@define "screenSize",
		get: ->
			if @isLandscape
				return size =
					width: @_device.screenHeight
					height: @_device.screenWidth
			else
				return size =
					width: @_device.screenWidth
					height: @_device.screenHeight

	@define "type",
		get: ->
			@_type
		set: (type) ->
			device = null
			return if Utils.isMobile()
			if Utils.isString(type)
				ltype = type.toLowerCase()
				for key in Utils.keys(Devices)
					lKey = key.toLowerCase()
					device = Devices[key] if ltype is lKey

			if not device
				throw Error "No device named #{type}. Options are: #{Utils.keys Devices}"

			if @_device is device
				return

			# If we switch from fullscreen to a device, we should zoom to fit
			shouldZoomToFit = @_type is "fullscreen"

			@screen.backgroundColor = "black"
			@screen.backgroundColor = device.backgroundColor if device.backgroundColor?

			if device.type is "computer"
				Utils.domComplete ->
					document.body.style.cursor = "auto"

			@_device = Utils.clone(device)
			@_type = type
			@fullscreen = false

			if @_device.screenDensity
				@contentScale = @_device.screenDensity
			else
				@contentScale = @_device.screenDensity
			@_updateDeviceImage()
			
			@emit("change:type")
			@viewport.point = @_viewportOrientationOffset()

			if shouldZoomToFit
				@deviceScale = "fit"

			@_update()
			
	###########################################################################
	# DEVICE ZOOM

	@define "deviceScale",
		get: ->
			return @_deviceScale or 1
		set: (deviceScale) -> @setDeviceScale(deviceScale, false)

	setDeviceScale: (deviceScale, animate=false) ->

		if deviceScale is "fit" or deviceScale < 0
			deviceScale = "fit"
		else
			deviceScale = parseFloat(deviceScale)

		if deviceScale is @_deviceScale
			return

		@_deviceScale = deviceScale

		if deviceScale is "fit"
			phoneScale = @_calculatePhoneScale()
		else
			phoneScale = deviceScale

		@emit("change:deviceScale")

	###########################################################################
	# CONTENT SCALE

	@define "contentScale",
		get: -> @_contentScale or 1
		set: (contentScale) -> @setContentScale(contentScale, false)

	setContentScale: (contentScale, animate=false) ->

		contentScale = parseFloat(contentScale)

		if contentScale <= 0
			return

		if contentScale is @_contentScale
			return

		@_contentScale = contentScale

		if animate
			@content.animate Utils.extend @animationOptions,
				properties: {scale: @_contentScale}
		else
			@content.scale = @_contentScale

		@_update()

		@emit("change:contentScale")

	###########################################################################
	# PHONE ORIENTATION

	@define "orientation",
		get: ->
			return window.orientation if Utils.isMobile()
			return @_orientation or 0

		set: (orientation) -> @setOrientation(orientation, false)

	setOrientation: (orientation, animate=false) ->

		if orientation is "portrait"
			orientation = 0

		if orientation is "landscape"
			orientation = 90

		orientation = parseInt(orientation)

		if orientation not in [0, 90, -90]
			return

		if orientation is @_orientation
			return

		@_orientation = orientation

		# Calculate properties for the phone
		phoneProperties =
			rotationZ: -@_orientation
			scale: @_calculatePhoneScale()

		contentProperties = @_viewportOrientationOffset()

		@viewport.animateStop()

		if animate
			@viewport.animate Utils.extend @animationOptions,
				properties: contentProperties

			animation.on Event.AnimationEnd, =>
				@_update()
		else
			@viewport.props = contentProperties
			@_update()

		@emit("change:orientation", @_orientation)


	@define "isPortrait", get: -> Math.abs(@orientation) % 180 is 0
	@define "isLandscape", get: -> not @isPortrait

	@define "orientationName",
		get: ->
			return "portrait" if @isPortrait
			return "landscape" if @isLandscape
		set: (orientationName) -> @setOrientation(orientationName, false)

	rotateLeft: (animate=true) ->
		return if @orientation is 90
		@setOrientation(@orientation + 90, animate)

	rotateRight: (animate=true) ->
		return if @orientation is -90
		@setOrientation(@orientation - 90, animate)


	###########################################################################
	# SETUP

	_setup: ->
		if @_setupDone
			return
	
		@_setupDone = true

		@background = new View
			parent: @
		@background.clip = true
		@background.backgroundColor = "transparent"
		@background.classList.add("DeviceBackground")

		@hands    = new View
			parent: @
		@phone    = new View parent: @hands
		@screen   = new View parent: @phone
		@viewport = new View parent: @screen
		@content  = new View parent: @viewport

		@hands.backgroundColor = "transparent"

		@phone.backgroundColor = "transparent"
		@phone.classList.add("DevicePhone")

		@screen.classList.add("DeviceScreen")
		@screen.clip = true

		@viewport.backgroundColor = "transparent"
		@viewport.classList.add("DeviceComponentPort")

		@content.backgroundColor = "transparent"
		@content.classList.add("DeviceContent")

		@content.originX = 0
		@content.originY = 0

		# This avoids rubber banding on mobile
		for view in [@background, @phone, @viewport, @content, @screen]
			view.on "touchmove", (event) -> event.preventDefault()

		@_context = new Context(parent: @content, name: "DeviceScreen")
		@_context.perspective = 1200
		@_context.device = @

	_update: =>

		contentScaleFactor = @contentScale
		backgroundOverlap = 100

		@background.x = 0 - backgroundOverlap
		@background.y = 0 - backgroundOverlap
		@background.width  = window.innerWidth  + (2 * backgroundOverlap)
		@background.height = window.innerHeight + (2 * backgroundOverlap)

		@_updateDeviceImage()
		@hands.scale = @_calculatePhoneScale()
		@hands.center()
		@phone.center()

		[width, height] = @_getOrientationDimensions(
			@_device.screenWidth / contentScaleFactor,
			@_device.screenHeight / contentScaleFactor)

		@screen.width  = @viewport.width = @_device.screenWidth
		@screen.height = @viewport.height = @_device.screenHeight

		@content.width  = width
		@content.height = height

		@screen.center()

	_updateDeviceImage: =>
		@phone.image  = @_imageUrl(@_imageName())
		@phone.width  = @_device.imageWidth
		@phone.height = @_device.imageHeight
		@hands.width  = @phone.width
		@hands.height = @phone.height

	_imageName: ->
		if @_device.hasOwnProperty("image")
			return @_device.image
		return "#{@_type}.png"


	_calculatePhoneScale: ->

		# Calculates a phone scale that fits the screen unless a fixed value is set

		[width, height] = @_getOrientationDimensions(@phone.width, @phone.height)

		paddingOffset = @_device?.paddingOffset or 0

		phoneScale = Utils.min([
			(window.innerWidth - ((@padding.left + @padding.right + paddingOffset) * 2)) / width,
			(window.innerHeight - ((@padding.top + @padding.bottom + paddingOffset) * 2)) / height
		])

		# Never scale the phone beyond 100%
		phoneScale = 1 if phoneScale > 1

		@emit("change:phoneScale", phoneScale)

		if @_deviceScale and @_deviceScale isnt "fit"
			return @_deviceScale
		return phoneScale

	_viewportOrientationOffset: =>

		[width, height] = @_getOrientationDimensions(@_device.screenWidth, @_device.screenHeight)

		@content.width = width/2
		@content.height = height/2

		offset = (@screen.width - width) / 2
		offset *= -1 if @_orientation is -90

		[x, y] = [0, 0]

		if @isLandscape
			x = offset
			y = offset

		return contentProperties =
			rotationZ: @_orientation
			x: x
			y: y

	_orientationChange: =>
		@_orientation = window.orientation
		@_update()
		@emit("change:orientation", window.orientation)


	_getOrientationDimensions: (width, height) ->
		if @isLandscape then [height, width] else [width, height]


	_imageUrl: (name) ->

		return null unless name

		# If the image is externally hosted, we'd like to use that
		if Utils.startsWith(name, "http://") or Utils.startsWith(name, "https://")
			return name

		# If this device is added by the user we use the name as it is
		if @_type not in BuiltInDevices or @_type is "custom"
			return name

		# We want to get these image from our public resources server
		resourceUrl = "//s3.amazonaws.com/data.magixjs.com/static/devices"

		if Utils.isFileUrl(window.location.href)
			resourceUrl = "http:#{resourceUrl}"

		return "#{resourceUrl}/#{name}"

	toInspect: ->
		return "<Device '#{@type}' #{@screenSize.width}x#{@screenSize.height}>"

for item of devicesShortcuts
	Device[item] = devicesShortcuts[item]